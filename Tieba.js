/*
ç™¾åº¦è´´å§ç­¾åˆ°ï¼Œå¢åŠ é‡è¯•æœºåˆ¶ï¼Œå‡å°‘ç­¾åˆ°å¤±è´¥çš„æƒ…å†µã€‚
è„šæœ¬ä¸ºä¸²è¡Œæ‰§è¡Œï¼Œé€šè¿‡è®¾å®šbatchSizeçš„å€¼<int>ï¼Œå®ç°æ¯æ‰¹å¤šå°‘ä¸ªè´´å§å¹¶è¡Œç­¾åˆ°ä¸€æ¬¡ã€‚
*/
constÂ scriptNameÂ =Â "ç™¾åº¦è´´å§";
constÂ batchSizeÂ =Â 20;
constÂ retriesÂ =Â 10;Â //Â ç­¾åˆ°å¤±è´¥é‡è¯•æ¬¡æ•°
constÂ intervalÂ =Â 5000;Â //Â æ¯æ¬¡é‡è¯•é—´éš”
constÂ tiebaCookieKeyÂ =Â "tieba_signin_cookie";
constÂ tiebeGetCookieRegex1Â =
Â Â /https?:\/\/(c\.tieba\.baidu\.com|180\.97\.\d+\.\d+)\/c\/s\/login/;
constÂ tiebeGetCookieRegex2Â =
Â Â /^https?:\/\/c\.tieba\.baidu\.com\/c\/s\/channelIconConfig/;
constÂ tiebeGetCookieRegex3Â =
Â Â /https?:\/\/tiebac\.baidu\.com\/c\/u\/follow\/getFoldedMessageUserInfo/;

constÂ $Â =Â MagicJS(scriptName,Â "INFO");
letÂ currentCookieÂ =Â "";

functionÂ addCookie(config)Â {
Â Â config.headers["Cookie"]Â =Â currentCookie;
Â Â returnÂ config;
}
$.http.interceptors.request.use(addCookie);

functionÂ getTieBaList()Â {
Â Â returnÂ newÂ Promise((resolve,Â reject)Â =>Â {
Â Â Â Â $.http
Â Â Â Â Â Â .get({
Â Â Â Â Â Â Â Â url:Â "https://tieba.baidu.com/mo/q/newmoindex",
Â Â Â Â Â Â Â Â headers:Â {
Â Â Â Â Â Â Â Â Â Â "Content-Type":Â "application/octet-stream",
Â Â Â Â Â Â Â Â Â Â Referer:Â "https://tieba.baidu.com/index/tbwise/forum",
Â Â Â Â Â Â Â Â Â Â "User-Agent":
Â Â Â Â Â Â Â Â Â Â Â Â "Mozilla/5.0Â (iPhone;Â CPUÂ iPhoneÂ OSÂ 12_0Â likeÂ MacÂ OSÂ X)Â AppleWebKit/605.1.15Â (KHTML,Â likeÂ Gecko)Â Mobile/16A366",
Â Â Â Â Â Â Â Â },
Â Â Â Â Â Â Â Â body:Â "",
Â Â Â Â Â Â })
Â Â Â Â Â Â .then((resp)Â =>Â {
Â Â Â Â Â Â Â Â constÂ objÂ =Â resp.body;
Â Â Â Â Â Â Â Â ifÂ (obj.errorÂ ===Â "success")Â {
Â Â Â Â Â Â Â Â Â Â $.logger.info(
Â Â Â Â Â Â Â Â Â Â Â Â `è·å–è´´å§åˆ—è¡¨æˆåŠŸï¼Œå…±å…³æ³¨${obj.data["like_forum"].length}ä¸ªè´´å§`
Â Â Â Â Â Â Â Â Â Â );
Â Â Â Â Â Â Â Â Â Â resolve([obj.data["tbs"],Â obj.data["like_forum"]]);
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â })
Â Â Â Â Â Â .catch((err)Â =>Â {
Â Â Â Â Â Â Â Â constÂ errMsgÂ =Â `è·å–è´´å§åˆ—è¡¨å¤±è´¥ï¼Œ${err}`;
Â Â Â Â Â Â Â Â $.logger.error();
Â Â Â Â Â Â Â Â $.notification.post("è·å–è´´å§åˆ—è¡¨å¤±è´¥ï¼Œè¯·æŸ¥é˜…æ—¥å¿—");
Â Â Â Â Â Â Â Â reject(errMsg);
Â Â Â Â Â Â });
Â Â });
}

functionÂ tiebaSignIn(tbs,Â tieba)Â {
Â Â constÂ kwÂ =Â tieba["forum_name"];
Â Â returnÂ newÂ Promise((resolve,Â reject)Â =>Â {
Â Â Â Â ifÂ (tieba["is_sign"]Â ===Â 1)Â {
Â Â Â Â Â Â resolve(`[${kw}]Â é‡å¤ç­¾åˆ°`);
Â Â Â Â }Â elseÂ {
Â Â Â Â Â Â letÂ msgÂ =Â "";
Â Â Â Â Â Â constÂ bodyÂ =Â `tbs=${tbs}&kw=${kw}&ie=utf-8`;
Â Â Â Â Â Â $.http
Â Â Â Â Â Â Â Â .post({
Â Â Â Â Â Â Â Â Â Â url:Â "https://tieba.baidu.com/sign/add",
Â Â Â Â Â Â Â Â Â Â headers:Â {
Â Â Â Â Â Â Â Â Â Â Â Â Accept:Â "application/json,Â text/javascript,Â */*;Â q=0.01",
Â Â Â Â Â Â Â Â Â Â Â Â "Accept-Encoding":Â "gzip,deflate,br",
Â Â Â Â Â Â Â Â Â Â Â Â "Accept-Language":
Â Â Â Â Â Â Â Â Â Â Â Â Â Â "zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6",
Â Â Â Â Â Â Â Â Â Â Â Â "Content-Type":Â "application/x-www-form-urlencoded;Â charset=UTF-8",
Â Â Â Â Â Â Â Â Â Â Â Â Connection:Â "keep-alive",
Â Â Â Â Â Â Â Â Â Â Â Â Host:Â "tieba.baidu.com",
Â Â Â Â Â Â Â Â Â Â Â Â Referer:Â "https://tieba.baidu.com/",
Â Â Â Â Â Â Â Â Â Â Â Â "x-requested-with":Â "XMLHttpRequest",
Â Â Â Â Â Â Â Â Â Â Â Â "User-Agent":
Â Â Â Â Â Â Â Â Â Â Â Â Â Â "Mozilla/5.0Â (WindowsÂ NTÂ 10.0;Â Win64;Â x64)Â AppleWebKit/537.36Â (KHTML,Â likeÂ Gecko)Â Chrome/84.0.4147.135Â Safari/537.36Â Edg/84.0.522.63",
Â Â Â Â Â Â Â Â Â Â },
Â Â Â Â Â Â Â Â Â Â body:Â body,
Â Â Â Â Â Â Â Â })
Â Â Â Â Â Â Â Â .then((resp)Â =>Â {
Â Â Â Â Â Â Â Â Â Â constÂ objÂ =Â resp.body;
Â Â Â Â Â Â Â Â Â Â ifÂ (
Â Â Â Â Â Â Â Â Â Â Â Â obj.data["errmsg"]Â ===Â "success"Â &&
Â Â Â Â Â Â Â Â Â Â Â Â obj.data.errnoÂ ===Â 0Â &&
Â Â Â Â Â Â Â Â Â Â Â Â obj.data["uinfo"]["is_sign_in"]Â ===Â 1
Â Â Â Â Â Â Â Â Â Â )Â {
Â Â Â Â Â Â Â Â Â Â Â Â msgÂ =Â `[${kw}]Â ç­¾åˆ°æˆåŠŸÂ æ’åÂ ${obj.data["uinfo"]["user_sign_rank"]}Â ç§¯åˆ†Â ${obj.data["uinfo"]["cont_sign_num"]}`;
Â Â Â Â Â Â Â Â Â Â Â Â $.logger.info(msg);
Â Â Â Â Â Â Â Â Â Â Â Â resolve(msg);
Â Â Â Â Â Â Â Â Â Â }Â elseÂ {
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (obj["no"]Â ===Â 2150040)Â {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â msgÂ =Â `[${kw}]Â ç­¾åˆ°å¤±è´¥ï¼ŒneedÂ vcode`;
Â Â Â Â Â Â Â Â Â Â Â Â }Â elseÂ ifÂ (obj["no"]Â ===Â 1011)Â {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â msgÂ =Â `[${kw}]Â æœªåŠ å…¥æ­¤å§æˆ–ç­‰çº§ä¸å¤Ÿ`;
Â Â Â Â Â Â Â Â Â Â Â Â }Â elseÂ ifÂ (obj["no"]Â ===Â 1102)Â {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â msgÂ =Â `[${kw}]Â ç­¾åˆ°è¿‡å¿«`;
Â Â Â Â Â Â Â Â Â Â Â Â }Â elseÂ ifÂ (obj["no"]Â ===Â 1101)Â {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â msgÂ =Â `[${kw}]Â é‡å¤ç­¾åˆ°`;
Â Â Â Â Â Â Â Â Â Â Â Â }Â elseÂ ifÂ (obj["no"]Â ===Â 1010)Â {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â msgÂ =Â `[${kw}]Â ç›®å½•å‡ºé”™`;
Â Â Â Â Â Â Â Â Â Â Â Â }Â elseÂ {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â msgÂ =Â `[${kw}]Â ç­¾åˆ°å¤±è´¥`;
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â $.logger.warning(`${msg}\n${JSON.stringify(obj)}`);
Â Â Â Â Â Â Â Â Â Â Â Â reject(msg);
Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â })
Â Â Â Â Â Â Â Â .catch((err)Â =>Â {
Â Â Â Â Â Â Â Â Â Â msgÂ =Â `[${kw}]Â ç­¾åˆ°å¼‚å¸¸`;
Â Â Â Â Â Â Â Â Â Â $.logger.warning(`${kw}Â ç­¾åˆ°å¼‚å¸¸\n${err}`);
Â Â Â Â Â Â Â Â Â Â reject(msg);
Â Â Â Â Â Â Â Â });
Â Â Â Â }
Â Â });
}

functionÂ getUserInfo()Â {
Â Â returnÂ newÂ Promise((resolve,Â reject)Â =>Â {
Â Â Â Â $.http
Â Â Â Â Â Â .get({
Â Â Â Â Â Â Â Â url:Â "https://tieba.baidu.com/mo/q/sync",
Â Â Â Â Â Â Â Â headers:Â {
Â Â Â Â Â Â Â Â Â Â Accept:Â "application/json,Â text/javascript,Â */*;Â q=0.01",
Â Â Â Â Â Â Â Â Â Â "Accept-Encoding":Â "gzip,Â deflate,Â br",
Â Â Â Â Â Â Â Â Â Â "Accept-Language":Â "zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6",
Â Â Â Â Â Â Â Â Â Â Connection:Â "keep-alive",
Â Â Â Â Â Â Â Â Â Â Host:Â "tieba.baidu.com",
Â Â Â Â Â Â Â Â Â Â Referer:Â "https://tieba.baidu.com/home/main",
Â Â Â Â Â Â Â Â },
Â Â Â Â Â Â })
Â Â Â Â Â Â .then((resp)Â =>Â {
Â Â Â Â Â Â Â Â ifÂ (resp.body["no"]Â ===Â 0Â &&Â resp.body.errorÂ ===Â "success")Â {
Â Â Â Â Â Â Â Â Â Â resolve(resp.body.data["user_id"]);
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â })
Â Â Â Â Â Â .catch((err)Â =>Â {
Â Â Â Â Â Â Â Â $.logger.error(`è·å–ç”¨æˆ·ä¿¡æ¯å‡ºç°å‡ºç°å¼‚å¸¸ï¼Œ${err}`);
Â Â Â Â Â Â Â Â reject(err);
Â Â Â Â Â Â });
Â Â });
}

asyncÂ functionÂ multiUsersSignIn()Â {
Â Â constÂ allSessionNamesÂ =Â $.data.allSessionNames(tiebaCookieKey);
Â Â ifÂ (allSessionNames.lengthÂ ===Â 0)Â {
Â Â Â Â $.logger.error(`æ²¡æœ‰éœ€è¦ç­¾åˆ°çš„Cookieï¼Œè¯·å…ˆç™»å½•ç™¾åº¦è´´å§`);
Â Â Â Â $.notification.post(`æ²¡æœ‰éœ€è¦ç­¾åˆ°çš„Cookieï¼Œè¯·å…ˆç™»å½•ç™¾åº¦è´´å§`);
Â Â Â Â $.done();
Â Â }
Â Â $.logger.info(`æœ¬æ¬¡ä¸€å…±éœ€è¦ç­¾åˆ°Â ${allSessionNames.length}Â ä¸ªCookies`);
Â Â forÂ (letÂ [index,Â sessionKey]Â ofÂ allSessionNames.entries())Â {
Â Â Â Â currentCookieÂ =Â $.data.read(tiebaCookieKey,Â null,Â sessionKey);
Â Â Â Â ifÂ (!currentCookie)Â {
Â Â Â Â Â Â $.logger.error(`CookieÂ ${sessionKey}Â ä¸å­˜åœ¨`);
Â Â Â Â }Â elseÂ {
Â Â Â Â Â Â $.logger.info(`å½“å‰æ­£åœ¨è¿›è¡Œç¬¬Â ${indexÂ +Â 1}Â ä¸ªCookieç­¾åˆ°`);
Â Â Â Â Â Â letÂ contentÂ =Â "ğŸ¥ºå¾ˆé—æ†¾ï¼Œä»¥ä¸‹è´´å§ç­¾åˆ°å¤±è´¥ï¼š";
Â Â Â Â Â Â letÂ successÂ =Â 0;
Â Â Â Â Â Â letÂ failureÂ =Â 0;
Â Â Â Â Â Â constÂ [tbs,Â tiebaList]Â =Â awaitÂ $.utils.retry(
Â Â Â Â Â Â Â Â getTieBaList,
Â Â Â Â Â Â Â Â retries,
Â Â Â Â Â Â Â Â interval
Â Â Â Â Â Â )();
Â Â Â Â Â Â constÂ tiebaCountÂ =Â tiebaList.length;
Â Â Â Â Â Â constÂ cycleNumberÂ =Â Math.ceil(tiebaList.lengthÂ /Â batchSize);
Â Â Â Â Â Â forÂ (letÂ iÂ =Â 0;Â iÂ <Â cycleNumber;Â i++)Â {
Â Â Â Â Â Â Â Â letÂ batchTiebaPromiseÂ =Â [];
Â Â Â Â Â Â Â Â constÂ batchTiebaListÂ =Â tiebaList.splice(0,Â batchSize);
Â Â Â Â Â Â Â Â forÂ (letÂ tiebaÂ ofÂ batchTiebaList)Â {
Â Â Â Â Â Â Â Â Â Â batchTiebaPromise.push(
Â Â Â Â Â Â Â Â Â Â Â Â $.utils.retry(tiebaSignIn,Â retries,Â interval)(tbs,Â tieba)
Â Â Â Â Â Â Â Â Â Â );
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â awaitÂ Promise.all(batchTiebaPromise).then((result)Â =>Â {
Â Â Â Â Â Â Â Â Â Â result.forEach((element)Â =>Â {
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (
Â Â Â Â Â Â Â Â Â Â Â Â Â Â element.indexOf("ç­¾åˆ°æˆåŠŸ")Â <Â 0Â &&
Â Â Â Â Â Â Â Â Â Â Â Â Â Â element.indexOf("é‡å¤ç­¾åˆ°")Â <Â 0Â Â Â Â Â Â Â Â Â Â Â Â )Â {Â Â Â Â Â Â Â Â Â Â Â Â Â Â failureÂ +=Â 1;Â Â Â Â Â Â Â Â Â Â Â Â Â Â contentÂ +=Â `\n${element}`;Â Â Â Â Â Â Â Â Â Â Â Â }Â elseÂ {Â Â Â Â Â Â Â Â Â Â Â Â Â Â successÂ +=Â 1;Â Â Â Â Â Â Â Â Â Â Â Â }Â Â Â Â Â Â Â Â Â Â });Â Â Â Â Â Â Â Â });Â Â Â Â Â Â }Â Â Â Â Â Â $.notification.post(Â Â Â Â Â Â Â Â scriptName,Â Â Â Â Â Â Â Â `ç­¾åˆ°${tiebaCount}ä¸ªï¼ŒæˆåŠŸ${success}ä¸ªï¼Œå¤±è´¥${failure}ä¸ªï¼`,Â Â Â Â Â Â Â Â !!failureÂ >Â 0Â ?Â contentÂ :Â "ğŸ‰æ­å–œï¼Œæ‰€æœ‰è´´å§ç­¾åˆ°æˆåŠŸï¼ï¼"Â Â Â Â Â Â );Â Â Â Â Â Â $.logger.info(`ç¬¬Â ${indexÂ +Â 1}Â ä¸ªCookieç­¾åˆ°å®Œæ¯•`);Â Â Â Â }Â Â }}
(asyncÂ ()Â =>Â {Â Â try{Â Â //Â è·å–ç™¾åº¦è´´å§CookieÂ Â ifÂ (Â Â Â Â $.isRequestÂ &&Â Â Â Â (tiebeGetCookieRegex1.test($.request.url)Â ||Â Â Â Â Â Â tiebeGetCookieRegex2.test($.request.url)Â ||Â Â Â Â Â Â tiebeGetCookieRegex3.test($.request.url))Â Â )Â {Â Â Â Â tryÂ {Â Â Â Â Â Â constÂ cookieÂ =Â $.request.headers.CookieÂ ||Â $.request.headers.cookie;Â Â Â Â Â Â currentCookieÂ =Â cookie;Â Â Â Â Â Â $.logger.info(`è·å–ç™¾åº¦è´´å§Cookies(è¯·å‹¿æ³„éœ²):\n${cookie}`);Â Â Â Â Â Â ifÂ (!!cookie)Â {Â Â Â Â Â Â Â Â letÂ userIdÂ =Â awaitÂ getUserInfo();Â Â Â Â Â Â Â Â ifÂ (!userId)Â {Â Â Â Â Â Â Â Â Â Â userIdÂ =Â "default";Â Â Â Â Â Â Â Â }Â Â Â Â Â Â Â Â $.logger.info(`è·å–ç”¨æˆ·Id:${userId}`);Â Â Â Â Â Â Â Â constÂ resultÂ =Â $.data.update(tiebaCookieKey,Â cookie,Â userId);Â Â Â Â Â Â Â Â ifÂ (result)Â {Â Â Â Â Â Â Â Â Â Â constÂ msgÂ =Â "ğŸˆè·å–ç™¾åº¦è´´å§CookieæˆåŠŸ";Â Â Â Â Â Â Â Â Â Â $.notification.post(msg);Â Â Â Â Â Â Â Â Â Â $.logger.info(msg);Â Â Â Â Â Â Â Â }Â elseÂ {Â Â Â Â Â Â Â Â Â Â $.logger.info("Cookieæ²¡æœ‰å˜åŒ–ï¼Œæ— éœ€æ›´æ–°");Â Â Â Â Â Â Â Â }Â Â Â Â Â Â Â Â constÂ syncQinglongÂ =Â $.data.read("tieba_sync_qinglong",Â false);Â Â Â Â Â Â Â Â $.logger.info(Â Â Â Â Â Â Â Â Â Â `${syncQinglongÂ ===Â trueÂ ?Â ""Â :Â "ä¸"}åŒæ­¥Cookieåˆ°é’é¾™é¢æ¿`Â Â Â Â Â Â Â Â );Â Â Â Â Â Â Â Â ifÂ (syncQinglongÂ ===Â true)Â {Â Â Â Â Â Â Â Â Â Â constÂ msgÂ =Â "ğŸˆç™¾åº¦è´´å§CookieåŒæ­¥åˆ°é’é¾™é¢æ¿æˆåŠŸ";Â Â Â Â Â Â Â Â Â Â constÂ resultÂ =Â awaitÂ $.qinglong.update(Â Â Â Â Â Â Â Â Â Â Â Â tiebaCookieKey,Â Â Â Â Â Â Â Â Â Â Â Â cookie,Â Â Â Â Â Â Â Â Â Â Â Â userIdÂ Â Â Â Â Â Â Â Â Â );Â Â Â Â Â Â Â Â Â Â ifÂ (result)Â {Â Â Â Â Â Â Â Â Â Â Â Â $.notification.post(Â Â Â Â Â Â Â Â Â Â Â Â Â Â `${scriptName}Â -Â ${userId}`,Â Â Â Â Â Â Â Â Â Â Â Â Â Â "",Â Â Â Â Â Â Â Â Â Â Â Â Â Â `å·²å°†æ‚¨çš„ä¿¡æ¯åŒæ­¥è‡³é’é¾™é¢æ¿ï¼š\n${$.qinglong.url}\nå¦‚ä¸Šè¿°åœ°å€ä¸æ˜¯æ‚¨æ‰€é…ç½®ï¼Œåˆ™ä¿¡æ¯å·²æ³„éœ²ï¼\nè¯·ç«‹å³åœç”¨è„šæœ¬ï¼Œæ›´æ”¹å¯†ç ï¼\næ£€æŸ¥é’é¾™é¢æ¿é…ç½®æ˜¯å¦è¢«ç¯¡æ”¹ï¼`Â Â Â Â Â Â Â Â Â Â Â Â );Â Â Â Â Â Â Â Â Â Â Â Â $.logger.info(msg);Â Â Â Â Â Â Â Â Â Â }Â Â Â Â Â Â Â Â }Â Â Â Â Â Â }Â Â Â Â }Â catchÂ (err)Â {Â Â Â Â Â Â $.logger.error(err);Â Â Â Â }Â Â }Â Â //Â ç­¾åˆ°Â Â elseÂ {Â Â Â Â awaitÂ multiUsersSignIn();Â Â }Â Â $.done();}catch(err){Â Â console.log("å‡ºé”™äº†"Â +Â err);}finally{$.done()}})();
/**Â *Â *Â $$\Â Â Â Â Â Â $$\Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â $$\Â Â Â Â Â Â Â Â Â Â Â Â Â $$$$$\Â Â $$$$$$\Â Â Â Â Â Â Â Â Â $$$$$$\Â *Â $$$\Â Â Â Â $$$Â |Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \__|Â Â Â Â Â Â Â Â Â Â Â Â \__$$Â |$$Â Â __$$\Â Â Â Â Â Â Â $$Â ___$$\Â *Â $$$$\Â Â $$$$Â |Â $$$$$$\Â Â Â $$$$$$\Â Â $$\Â Â $$$$$$$\Â Â Â Â Â Â $$Â |$$Â /Â Â \__|Â Â Â Â Â Â \_/Â Â Â $$Â |Â *Â $$\$$\$$Â $$Â |Â \____$$\Â $$Â Â __$$\Â $$Â |$$Â Â _____|Â Â Â Â Â $$Â |\$$$$$$\Â Â Â Â Â Â Â Â Â Â $$$$$Â /Â *Â $$Â \$$$Â Â $$Â |Â $$$$$$$Â |$$Â /Â Â $$Â |$$Â |$$Â /Â Â Â Â Â $$\Â Â Â $$Â |Â \____$$\Â Â Â Â Â Â Â Â Â \___$$\Â *Â $$Â |\$Â Â /$$Â |$$Â Â __$$Â |$$Â |Â Â $$Â |$$Â |$$Â |Â Â Â Â Â $$Â |Â Â $$Â |$$\Â Â Â $$Â |Â Â Â Â Â Â $$\Â Â Â $$Â |Â *Â $$Â |Â \_/Â $$Â |\$$$$$$$Â |\$$$$$$$Â |$$Â |\$$$$$$$\\$$$$$$Â Â |\$$$$$$Â Â |Â Â Â Â Â Â \$$$$$$Â Â |Â *Â \__|Â Â Â Â Â \__|Â \_______|Â \____$$Â |\__|Â \_______|\______/Â Â \______/Â Â Â Â Â Â Â Â \______/Â *Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â $$\Â Â Â $$Â |Â *Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \$$$$$$Â Â |Â *Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \______/Â *Â *///Â @formatter:offfunctionÂ MagicJS(e="MagicJS",t="INFO"){constÂ i=()=>{constÂ e=typeofÂ $loon!=="undefined";constÂ t=typeofÂ $task!=="undefined";constÂ n=typeofÂ module!=="undefined";constÂ i=typeofÂ $httpClient!=="undefined"&&!e;constÂ s=typeofÂ $storm!=="undefined";constÂ r=typeofÂ $environment!=="undefined"&&typeofÂ $environment["stash-build"]!=="undefined";constÂ o=i||e||s||r;constÂ u=typeofÂ importModule!=="undefined";return{isLoon:e,isQuanX:t,isNode:n,isSurge:i,isStorm:s,isStash:r,isSurgeLike:o,isScriptable:u,getÂ name(){if(e){return"Loon"}elseÂ if(t){return"QuantumultX"}elseÂ if(n){return"NodeJS"}elseÂ if(i){return"Surge"}elseÂ if(u){return"Scriptable"}else{return"unknown"}},getÂ build(){if(i){returnÂ $environment["surge-build"]}elseÂ if(r){returnÂ $environment["stash-build"]}elseÂ if(s){returnÂ $storm.buildVersion}},getÂ language(){if(i||r){returnÂ $environment["language"]}},getÂ version(){if(i){returnÂ $environment["surge-version"]}elseÂ if(r){returnÂ $environment["stash-version"]}elseÂ if(s){returnÂ $storm.appVersion}elseÂ if(n){returnÂ process.version}},getÂ system(){if(i){returnÂ $environment["system"]}elseÂ if(n){returnÂ process.platform}},getÂ systemVersion(){if(s){returnÂ $storm.systemVersion}},getÂ deviceName(){if(s){returnÂ $storm.deviceName}}}};constÂ s=(n,e="INFO")=>{letÂ i=e;constÂ s={SNIFFER:6,DEBUG:5,INFO:4,NOTIFY:3,WARNING:2,ERROR:1,CRITICAL:0,NONE:-1};constÂ r={SNIFFER:"",DEBUG:"",INFO:"",NOTIFY:"",WARNING:"â—Â ",ERROR:"âŒÂ ",CRITICAL:"âŒÂ ",NONE:""};constÂ t=(e,t="INFO")=>{if(!(s[i]<s[t.toUpperCase()]))console.log(`[${t}]Â [${n}]\n${r[t.toUpperCase()]}${e}\n`)};constÂ o=e=>{i=e};return{setLevel:o,sniffer:e=>{t(e,"SNIFFER")},debug:e=>{t(e,"DEBUG")},info:e=>{t(e,"INFO")},notify:e=>{t(e,"NOTIFY")},warning:e=>{t(e,"WARNING")},error:e=>{t(e,"ERROR")},retry:e=>{t(e,"RETRY")}}};returnÂ newÂ class{constructor(e,t){this._startTime=Date.now();this.version="3.0.0";this.scriptName=e;this.env=i();this.logger=s(e,t);this.http=typeofÂ MagicHttp==="function"?MagicHttp(this.env,this.logger):undefined;this.data=typeofÂ MagicData==="function"?MagicData(this.env,this.logger):undefined;this.notification=typeofÂ MagicNotification==="function"?MagicNotification(this.scriptName,this.env,this.logger):undefined;this.utils=typeofÂ MagicUtils==="function"?MagicUtils(this.env,this.logger):undefined;this.qinglong=typeofÂ MagicQingLong==="function"?MagicQingLong(this.env,this.data,this.logger):undefined;if(typeofÂ this.data!=="undefined"){letÂ e=this.data.read("magic_loglevel");constÂ n=this.data.read("magic_bark_url");if(e){this.logger.setLevel(e.toUpperCase())}if(n){this.notification.setBark(n)}}}getÂ isRequest(){returnÂ typeofÂ $request!=="undefined"&&typeofÂ $response==="undefined"}getÂ isResponse(){returnÂ typeofÂ $response!=="undefined"}getÂ isDebug(){returnÂ this.logger.level==="DEBUG"}getÂ request(){if(typeofÂ $request!=="undefined"){this.logger.sniffer(`RESPONSE:\n${JSON.stringify($request)}`);returnÂ $request}}getÂ response(){if(typeofÂ $response!=="undefined"){if($response.hasOwnProperty("status"))$response["statusCode"]=$response["status"];if($response.hasOwnProperty("statusCode"))$response["status"]=$response["statusCode"];this.logger.sniffer(`RESPONSE:\n${JSON.stringify($response)}`);returnÂ $response}else{returnÂ undefined}}done=(e={})=>{this._endTime=Date.now();letÂ t=(this._endTime-this._startTime)/1e3;this.logger.info(`SCRIPTÂ COMPLETED:Â ${t}Â S.`);if(typeofÂ $done!=="undefined"){$done(e)}}}(e,t)}functionÂ MagicHttp(c,l){constÂ e="Mozilla/5.0Â (iPhone;Â CPUÂ iPhoneÂ OSÂ 13_3_1Â likeÂ MacÂ OSÂ X)Â AppleWebKit/605.1.15Â (KHTML,Â likeÂ Gecko)Â Version/13.0.5Â Mobile/15E148Â Safari/604.1";constÂ t="Mozilla/5.0Â (WindowsÂ NTÂ 10.0;Â Win64;Â x64)Â AppleWebKit/537.36Â (KHTML,Â likeÂ Gecko)Â Chrome/84.0.4147.125Â Safari/537.36Â Edg/84.0.522.59";letÂ r;if(c.isNode){constÂ S=require("axios");r=S.create()}classÂ s{constructor(e=true){this.handlers=[];this.isRequest=e}use(e,t,r){this.handlers.push({fulfilled:e,rejected:t,synchronous:r?r.synchronous:false,runWhen:r?r.runWhen:null});returnÂ this.handlers.length-1}eject(e){if(this.handlers[e]){this.handlers[e]=null}}forEach(t){this.handlers.forEach(e=>{if(e!==null){t(e)}})}}functionÂ n(e){letÂ r={...e};if(!!r.params){if(!c.isNode){letÂ e=Object.keys(r.params).map(e=>{constÂ t=encodeURIComponent(e);r.url=r.url.replace(newÂ RegExp(`${e}=[^&]*`,"ig"),"");r.url=r.url.replace(newÂ RegExp(`${t}=[^&]*`,"ig"),"");return`${t}=${encodeURIComponent(r.params[e])}`}).join("&");if(r.url.indexOf("?")<0)r.url+="?";if(!/(&|\?)$/g.test(r.url)){r.url+="&"}r.url+=e;deleteÂ r.params;l.debug(`ParamsÂ toÂ QueryString:Â ${r.url}`)}}returnÂ r}constÂ d=(e,t)=>{letÂ r=typeofÂ t==="object"?{headers:{},...t}:{url:t,headers:{}};if(!r.method){r["method"]=e}r=n(r);if(r["rewrite"]===true){if(c.isSurge){r.headers["X-Surge-Skip-Scripting"]=false;deleteÂ r["rewrite"]}elseÂ if(c.isQuanX){r["hints"]=false;deleteÂ r["rewrite"]}}if(c.isSurge){if(r["method"]!=="GET"&&r.headers["Content-Type"].indexOf("application/json")>=0&&r.bodyÂ instanceofÂ Array){r.body=JSON.stringify(r.body);l.debug(`ConvertÂ ArrayÂ objectÂ toÂ String:Â ${r.body}`)}}elseÂ if(c.isQuanX){if(r.hasOwnProperty("body")&&typeofÂ r["body"]!=="string")r["body"]=JSON.stringify(r["body"]);r["method"]=e}elseÂ if(c.isNode){if(e==="POST"||e==="PUT"||e==="PATCH"||e==="DELETE"){r.data=r.data||r.body}elseÂ if(e==="GET"){r.params=r.params||r.body}deleteÂ r.body}returnÂ r};constÂ f=(t,r=null)=>{if(t){letÂ e={...t,config:t.config||r,status:t.statusCode||t.status,body:t.body||t.data,headers:t.headers||t.header};if(typeofÂ e.body==="string"){try{e.body=JSON.parse(e.body)}catch{}}deleteÂ t.data;returnÂ e}else{returnÂ t}};constÂ o=r=>{returnÂ Object.keys(r).reduce((e,t)=>{e[t.toLowerCase()]=r[t];returnÂ e},{})};constÂ i=s=>{returnÂ Object.keys(s).reduce((e,t)=>{constÂ r=t.split("-").map(e=>e[0].toUpperCase()+e.slice(1)).join("-");e[r]=s[t];returnÂ e},{})};constÂ h=(t,r=null)=>{if(!!t&&t.status>=400){l.debug(`RaiseÂ exceptionÂ whenÂ statusÂ codeÂ isÂ ${t.status}`);letÂ e={name:"RequestException",message:`RequestÂ failedÂ withÂ statusÂ codeÂ ${t.status}`,config:r||t.config,response:t};returnÂ e}};constÂ a={request:newÂ s,response:newÂ s(false)};letÂ p=[];letÂ y=[];letÂ g=true;functionÂ m(e){e=n(e);l.debug(`HTTPÂ ${e["method"].toUpperCase()}:\n${JSON.stringify(e)}`);returnÂ e}functionÂ b(e){try{e=!!e?f(e):e;l.sniffer(`HTTPÂ ${e.config["method"].toUpperCase()}:\n${JSON.stringify(e.config)}\nSTATUSÂ CODE:\n${e.status}\nRESPONSE:\n${typeofÂ e.body==="object"?JSON.stringify(e.body):e.body}`);constÂ t=h(e);if(!!t){returnÂ Promise.reject(t)}returnÂ e}catch(t){l.error(t);returnÂ e}}constÂ T=t=>{try{p=[];y=[];a.request.forEach(e=>{if(typeofÂ e.runWhen==="function"&&e.runWhen(t)===false){return}g=g&&e.synchronous;p.unshift(e.fulfilled,e.rejected)});a.response.forEach(e=>{y.push(e.fulfilled,e.rejected)})}catch(e){l.error(`FailedÂ toÂ registerÂ interceptors:Â ${e}.`)}};constÂ u=(e,s)=>{letÂ n;constÂ t=e.toUpperCase();s=d(t,s);if(c.isNode){n=r}else{if(c.isSurgeLike){n=o=>{returnÂ newÂ Promise((s,n)=>{$httpClient[e.toLowerCase()](o,(t,r,e)=>{if(t){letÂ e={name:t.name||t,message:t.message||t,stack:t.stack||t,config:o,response:f(r)};n(e)}else{r.config=o;r.body=e;s(r)}})})}}else{n=n=>{returnÂ newÂ Promise((r,s)=>{$task.fetch(n).then(e=>{e=f(e,n);constÂ t=h(e,n);if(t){returnÂ Promise.reject(t)}r(e)}).catch(e=>{letÂ t={name:e.message||e.error,message:e.message||e.error,stack:e.error,config:n,response:!!e.response?f(e.response):null};s(t)})})}}}letÂ o;T(s);constÂ i=[m,undefined];constÂ a=[b,undefined];if(!g){l.debug("InterceptorsÂ areÂ executedÂ inÂ asynchronousÂ mode.");letÂ r=[n,undefined];Array.prototype.unshift.apply(r,i);Array.prototype.unshift.apply(r,p);r=r.concat(a);r=r.concat(y);o=Promise.resolve(s);while(r.length){try{letÂ e=r.shift();letÂ t=r.shift();if(!c.isNode&&s["timeout"]&&e===n){o=u(s)}else{o=o.then(e,t)}}catch(e){l.error(`requestÂ exception:Â ${e}`)}}returnÂ o}else{l.debug("InterceptorsÂ areÂ executedÂ inÂ synchronousÂ mode.");Array.prototype.unshift.apply(p,i);p=p.concat([m,undefined]);while(p.length){letÂ e=p.shift();letÂ t=p.shift();try{s=e(s)}catch(e){t(e);break}}try{if(!c.isNode&&s["timeout"]){o=u(s)}else{o=n(s)}}catch(e){returnÂ Promise.reject(e)}Array.prototype.unshift.apply(y,a);while(y.length){o=o.then(y.shift(),y.shift())}returnÂ o}functionÂ u(r){try{constÂ e=newÂ Promise((e,t)=>{setTimeout(()=>{letÂ e={message:`timeoutÂ ofÂ ${r["timeout"]}msÂ exceeded.`,config:r};t(e)},r["timeout"])});returnÂ Promise.race([n(r),e])}catch(e){l.error(`RequestÂ TimeoutÂ exception:Â ${e}.`)}}};return{request:u,interceptors:a,convertHeadersToLowerCase:o,convertHeadersToCamelCase:i,modifyResponse:f,get:e=>{returnÂ u("GET",e)},post:e=>{returnÂ u("POST",e)},put:e=>{returnÂ u("PUT",e)},patch:e=>{returnÂ u("PATCH",e)},delete:e=>{returnÂ u("DELETE",e)},head:e=>{returnÂ u("HEAD",e)},options:e=>{returnÂ u("OPTIONS",e)}}}functionÂ MagicData(i,u){letÂ f={fs:undefined,data:{}};if(i.isNode){f.fs=require("fs");try{f.fs.accessSync("./magic.json",f.fs.constants.R_OK|f.fs.constants.W_OK)}catch(e){f.fs.writeFileSync("./magic.json","{}",{encoding:"utf8"})}f.data=require("./magic.json")}constÂ o=(e,t)=>{if(typeofÂ t==="object"){returnÂ false}else{returnÂ e===t}};constÂ a=e=>{if(e==="true"){returnÂ true}elseÂ if(e==="false"){returnÂ false}elseÂ if(typeofÂ e==="undefined"){returnÂ null}else{returnÂ e}};constÂ c=(e,t,s,n)=>{if(s){try{if(typeofÂ e==="string")e=JSON.parse(e);if(e["magic_session"]===true){e=e[s]}else{e=null}}catch{e=null}}if(typeofÂ e==="string"&&e!=="null"){try{e=JSON.parse(e)}catch{}}if(n===false&&!!e&&e["magic_session"]===true){e=null}if((e===null||typeofÂ e==="undefined")&&t!==null&&typeofÂ t!=="undefined"){e=t}e=a(e);returnÂ e};constÂ l=t=>{if(typeofÂ t==="string"){letÂ e={};try{e=JSON.parse(t);constÂ s=typeofÂ e;if(s!=="object"||eÂ instanceofÂ Array||s==="bool"||e===null){e={}}}catch{}returnÂ e}elseÂ if(tÂ instanceofÂ Array||t===null||typeofÂ t==="undefined"||t!==t||typeofÂ t==="boolean"){return{}}else{returnÂ t}};constÂ y=(e,t=null,s="",n=false,r=null)=>{letÂ l=r||f.data;if(!!l&&typeofÂ l[e]!=="undefined"&&l[e]!==null){val=l[e]}else{val=!!s?{}:null}val=c(val,t,s,n);returnÂ val};constÂ d=(e,t=null,s="",n=false,r=null)=>{letÂ l="";if(r||i.isNode){l=y(e,t,s,n,r)}else{if(i.isSurgeLike){l=$persistentStore.read(e)}elseÂ if(i.isQuanX){l=$prefs.valueForKey(e)}l=c(l,t,s,n)}u.debug(`READÂ DATAÂ [${e}]${!!s?`[${s}]`:""}Â <${typeofÂ l}>\n${JSON.stringify(l)}`);returnÂ l};constÂ p=(t,s,n="",e=null)=>{letÂ r=e||f.data;r=l(r);if(!!n){letÂ e=l(r[t]);e["magic_session"]=true;e[n]=s;r[t]=e}else{r[t]=s}if(e!==null){e=r}returnÂ r};constÂ S=(e,t,s="",n=null)=>{if(typeofÂ t==="undefined"||t!==t){returnÂ false}if(!i.isNode&&(typeofÂ t==="boolean"||typeofÂ t==="number")){t=String(t)}letÂ r="";if(n||i.isNode){r=p(e,t,s,n)}else{if(!s){r=t}else{if(i.isSurgeLike){r=!!$persistentStore.read(e)?$persistentStore.read(e):r}elseÂ if(i.isQuanX){r=!!$prefs.valueForKey(e)?$prefs.valueForKey(e):r}r=l(r);r["magic_session"]=true;r[s]=t}}if(!!r&&typeofÂ r==="object"){r=JSON.stringify(r,null,4)}u.debug(`WRITEÂ DATAÂ [${e}]${s?`[${s}]`:""}Â <${typeofÂ t}>\n${JSON.stringify(t)}`);if(!n){if(i.isSurgeLike){returnÂ $persistentStore.write(r,e)}elseÂ if(i.isQuanX){returnÂ $prefs.setValueForKey(r,e)}elseÂ if(i.isNode){try{f.fs.writeFileSync("./magic.json",r);returnÂ true}catch(e){u.error(e);returnÂ false}}}returnÂ true};constÂ e=(t,s,n,r=o,l=null)=>{s=a(s);constÂ e=d(t,null,n,false,l);if(r(e,s)===true){returnÂ false}else{constÂ i=S(t,s,n,l);letÂ e=d(t,null,n,false,l);if(r===o&&typeofÂ e==="object"){returnÂ i}returnÂ r(s,e)}};constÂ g=(e,t,s)=>{letÂ n=s||f.data;n=l(n);if(!!t){obj=l(n[e]);deleteÂ obj[t];n[e]=obj}else{deleteÂ n[e]}if(!!s){s=n}returnÂ n};constÂ t=(e,t="",s=null)=>{letÂ n={};if(s||i.isNode){n=g(e,t,s);if(!s){f.fs.writeFileSync("./magic.json",JSON.stringify(n,null,4))}else{s=n}}else{if(!t){if(i.isStorm){returnÂ $persistentStore.remove(e)}elseÂ if(i.isSurgeLike){returnÂ $persistentStore.write(null,e)}elseÂ if(i.isQuanX){returnÂ $prefs.removeValueForKey(e)}}else{if(i.isSurgeLike){n=$persistentStore.read(e)}elseÂ if(i.isQuanX){n=$prefs.valueForKey(e)}n=l(n);deleteÂ n[t];constÂ r=JSON.stringify(n,null,4);S(e,r)}}u.debug(`DELETEÂ KEYÂ [${e}]${!!t?`[${t}]`:""}`)};constÂ s=(e,t=null)=>{letÂ s=[];letÂ n=d(e,null,null,true,t);n=l(n);if(n["magic_session"]!==true){s=[]}else{s=Object.keys(n).filter(e=>e!=="magic_session")}u.debug(`READÂ ALLÂ SESSIONSÂ [${e}]Â <${typeofÂ s}>\n${JSON.stringify(s,null,4)}`);returnÂ s};constÂ n=(e,t=null)=>{letÂ s={};letÂ n=d(e,null,null,true,t);n=l(n);if(n["magic_session"]===true){s={...n};deleteÂ s["magic_session"]}u.debug(`READÂ ALLÂ SESSIONSÂ [${e}]Â <${typeofÂ s}>\n${JSON.stringify(s,null,4)}`);returnÂ s};return{read:d,write:S,del:t,update:e,allSessions:n,allSessionNames:s,defaultValueComparator:o,convertToObject:l}}functionÂ MagicNotification(r,f,l){letÂ s=null;letÂ u=null;constÂ c=typeofÂ MagicHttp==="function"?MagicHttp(f,l):undefined;constÂ e=t=>{try{letÂ e=t.replace(/\/+$/g,"");s=`${/^https?:\/\/([^/]*)/.exec(e)[0]}/push`;u=/\/([^\/]+)\/?$/.exec(e)[1]}catch(e){l.error(`BarkÂ urlÂ error:Â ${e}.`)}};functionÂ t(e=r,t="",i="",o=""){constÂ n=i=>{try{letÂ t={};if(typeofÂ i==="string"){if(f.isLoon)t={openUrl:i};elseÂ if(f.isQuanX)t={"open-url":i};elseÂ if(f.isSurge)t={url:i}}elseÂ if(typeofÂ i==="object"){if(f.isLoon){t["openUrl"]=!!i["open-url"]?i["open-url"]:"";t["mediaUrl"]=!!i["media-url"]?i["media-url"]:""}elseÂ if(f.isQuanX){t=!!i["open-url"]||!!i["media-url"]?i:{}}elseÂ if(f.isSurge){letÂ e=i["open-url"]||i["openUrl"];t=e?{url:e}:{}}}returnÂ t}catch(e){l.error(`FailedÂ toÂ convertÂ notificationÂ option,Â ${e}`)}returnÂ i};o=n(o);if(arguments.length==1){e=r;t="",i=arguments[0]}l.notify(`title:${e}\nsubTitle:${t}\nbody:${i}\noptions:${typeofÂ o==="object"?JSON.stringify(o):o}`);if(f.isSurge){$notification.post(e,t,i,o)}elseÂ if(f.isLoon){if(!!o)$notification.post(e,t,i,o);elseÂ $notification.post(e,t,i)}elseÂ if(f.isQuanX){$notify(e,t,i,o)}if(s&&u&&typeofÂ c!=="undefined"){p(e,t,i)}}functionÂ i(e=r,t="",i="",o=""){if(l.level==="DEBUG"){if(arguments.length==1){e=r;t="",i=arguments[0]}this.notify(e,t,i,o)}}functionÂ p(e=r,t="",i="",o=""){if(typeofÂ c==="undefined"||typeofÂ c.post==="undefined"){throw"BarkÂ notificationÂ needsÂ toÂ importÂ MagicHttpÂ module."}letÂ n={url:s,headers:{"Content-Type":"application/json;Â charset=utf-8"},body:{title:e,body:t?`${t}\n${i}`:i,device_key:u}};c.post(n).catch(e=>{l.error(`BarkÂ notifyÂ error:Â ${e}`)})}return{post:t,debug:i,bark:p,setBark:e}}functionÂ MagicUtils(r,h){constÂ e=(o,i=5,l=0,a=null)=>{return(...e)=>{returnÂ newÂ Promise((s,r)=>{functionÂ n(...t){Promise.resolve().then(()=>o.apply(this,t)).then(e=>{if(typeofÂ a==="function"){Promise.resolve().then(()=>a(e)).then(()=>{s(e)}).catch(e=>{if(i>=1){if(l>0)setTimeout(()=>n.apply(this,t),l);elseÂ n.apply(this,t)}else{r(e)}i--})}else{s(e)}}).catch(e=>{h.error(e);if(i>=1&&l>0){setTimeout(()=>n.apply(this,t),l)}elseÂ if(i>=1){n.apply(this,t)}else{r(e)}i--})}n.apply(this,e)})}};constÂ t=(e,t="yyyy-MM-ddÂ hh:mm:ss")=>{letÂ s={"M+":e.getMonth()+1,"d+":e.getDate(),"h+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),S:e.getMilliseconds()};if(/(y+)/.test(t))t=t.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length));for(letÂ eÂ inÂ s)if(newÂ RegExp("("+e+")").test(t))t=t.replace(RegExp.$1,RegExp.$1.length==1?s[e]:("00"+s[e]).substr((""+s[e]).length));returnÂ t};constÂ s=()=>{returnÂ t(newÂ Date,"yyyy-MM-ddÂ hh:mm:ss")};constÂ n=()=>{returnÂ t(newÂ Date,"yyyy-MM-dd")};constÂ o=t=>{returnÂ newÂ Promise(e=>setTimeout(e,t))};constÂ i=(e,t=null)=>{if(r.isNode){constÂ s=require("assert");if(t)s(e,t);elseÂ s(e)}else{if(e!==true){letÂ e=`AssertionError:Â ${t||"TheÂ expressionÂ evaluatedÂ toÂ aÂ falsyÂ value"}`;h.error(e)}}};return{retry:e,formatTime:t,now:s,today:n,sleep:o,assert:i}}functionÂ MagicQingLong(e,s,o){letÂ i="";letÂ l="";letÂ c="";letÂ u="";letÂ d="";letÂ n="";constÂ g="magic.json";constÂ r=3e3;constÂ f=MagicHttp(e,o);constÂ t=(e,n,r,t,a)=>{i=e;c=n;u=r;l=t;d=a};functionÂ a(e){i=i||s.read("magic_qlurl");n=n||s.read("magic_qltoken");returnÂ e}functionÂ p(e){if(!i){i=s.read("magic_qlurl")}if(e.url.indexOf(i)<0){e.url=`${i}${e.url}`}return{...e,timeout:r}}functionÂ y(e){e.params={...e.params,t:Date.now()};returnÂ e}functionÂ m(e){n=n||s.read("magic_qltoken");if(n){e.headers["authorization"]=`BearerÂ ${n}`}returnÂ e}functionÂ h(e){c=c||s.read("magic_qlclient");if(!!c){e.url=e.url.replace("/api/","/open/")}returnÂ e}asyncÂ functionÂ b(e){try{constÂ n=e.message||e.error||JSON.stringify(e);if((n.indexOf("NSURLErrorDomain")>=0&&n.indexOf("-1012")>=0||!!e.response&&e.response.status===401)&&!!e.config&&e.config.refreshToken!==true){o.warning(`QinglongÂ PanelÂ tokenÂ hasÂ expired.`);awaitÂ v();e.config["refreshToken"]=true;returnÂ awaitÂ f.request(e.config.method,e.config)}else{returnÂ Promise.reject(e)}}catch(e){returnÂ Promise.reject(e)}}f.interceptors.request.use(a,undefined);f.interceptors.request.use(p,undefined);f.interceptors.request.use(h,undefined,{runWhen:e=>{returnÂ e.url.indexOf("api/user/login")<0&&e.url.indexOf("open/auth/token")<0}});f.interceptors.request.use(m,undefined,{runWhen:e=>{returnÂ e.url.indexOf("api/user/login")<0&&e.url.indexOf("open/auth/token")<0}});f.interceptors.request.use(y,undefined,{runWhen:e=>{returnÂ e.url.indexOf("open/auth/token")<0&&e.url.indexOf("t=")<0}});f.interceptors.response.use(undefined,b);asyncÂ functionÂ v(){c=c||s.read("magic_qlclient");u=u||s.read("magic_qlsecrt");l=l||s.read("magic_qlname");d=d||s.read("magic_qlpwd");if(i&&c&&u){awaitÂ f.get({url:`/open/auth/token`,headers:{"content-type":"application/json"},params:{client_id:c,client_secret:u}}).then(e=>{if(Object.keys(e.body).length>0&&e.body.data&&e.body.data.token){o.info("SuccessfullyÂ loggedÂ inÂ toÂ QinglongÂ Panel");n=e.body.data.token;s.update("magic_qltoken",n);returnÂ n}else{throwÂ newÂ Error("GetÂ QinglongÂ PanelÂ tokenÂ failed.")}}).catch(e=>{o.error(`ErrorÂ loggingÂ inÂ toÂ QinglongÂ Panel.\n${e.message}`)})}elseÂ if(i&&l&&d){awaitÂ f.post({url:`/api/user/login`,headers:{"content-type":"application/json"},body:{username:l,password:d}}).then(e=>{o.info("SuccessfullyÂ loggedÂ inÂ toÂ QinglongÂ Panel");n=e.body.data.token;s.update("magic_qltoken",n);returnÂ n}).catch(e=>{o.error(`ErrorÂ loggingÂ inÂ toÂ QinglongÂ Panel.\n${e.message}`)})}}asyncÂ functionÂ w(n,r,t=null){i=i||s.read("magic_qlurl");if(t===null){letÂ e=awaitÂ E([{name:n,value:r}]);if(!!e&&e.length===1){returnÂ e[0]}}else{f.put({url:`/api/envs`,headers:{"content-type":"application/json"},body:{name:n,value:r,id:t}}).then(e=>{if(e.body.code===200){o.debug(`QINGLONGÂ UPDATEÂ ENVÂ ${n}Â <${typeofÂ r}>Â (${t})\n${JSON.stringify(r)}`);returnÂ true}else{o.error(`ErrorÂ updatingÂ environmentÂ variableÂ fromÂ QinglongÂ Panel.\n${JSON.stringify(e)}`)}}).catch(e=>{o.error(`ErrorÂ updatingÂ environmentÂ variableÂ fromÂ QinglongÂ Panel.\n${e.message}`);returnÂ false})}}asyncÂ functionÂ E(e){letÂ n=[];awaitÂ f.post({url:`/api/envs`,headers:{"content-type":"application/json"},body:e}).then(e=>{if(e.body.code===200){e.body.data.forEach(e=>{o.debug(`QINGLONGÂ ADDÂ ENVÂ ${e.name}Â <${typeofÂ e.value}>Â (${e.id})\n${JSON.stringify(e)}`);n.push(e.id)})}else{o.error(`ErrorÂ addingÂ environmentÂ variableÂ fromÂ QinglongÂ Panel.\n${JSON.stringify(e)}`)}}).catch(e=>{o.error(`ErrorÂ addingÂ environmentÂ variableÂ fromÂ QinglongÂ Panel.\n${e.message}`)});returnÂ n}asyncÂ functionÂ N(n){returnÂ awaitÂ f.delete({url:`/api/envs`,headers:{accept:"application/json","accept-language":"zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6",connection:"keep-alive","content-type":"application/json;charset=UTF-8","user-agent":"Mozilla/5.0Â (WindowsÂ NTÂ 10.0;Â Win64;Â x64)Â AppleWebKit/537.36Â (KHTML,Â likeÂ Gecko)Â Chrome/102.0.5005.63Â Safari/537.36Â Edg/102.0.1245.30"},body:n}).then(e=>{if(e.body.code===200){o.debug(`QINGLONGÂ DELETEÂ ENVÂ IDS:Â ${n}`);returnÂ true}else{o.error(`ErrorÂ deletingÂ environmentÂ variableÂ fromÂ QinglongÂ Panel.\n${JSON.stringify(e)}`);returnÂ false}}).catch(e=>{o.error(`ErrorÂ deletingÂ environmentÂ variableÂ fromÂ QinglongÂ Panel.\n${e.message}`)})}asyncÂ functionÂ O(t=null,a="",i=0){if(i<=3){letÂ r=[];awaitÂ f.get({url:`/api/envs`,headers:{"content-type":"application/json"},params:{searchValue:a}}).then(e=>{if(e.body.code===200){constÂ n=e.body.data;if(!!t){letÂ e=[];for(constÂ eÂ ofÂ n){if(e.name===t){r.push(e)}}r=e}r=n}else{o.error(`ErrorÂ readingÂ environmentÂ variableÂ fromÂ QinglongÂ Panel.\n${JSON.stringify(e)}`);b();i+=1;O(t,a,i)}}).catch(e=>{o.error(`ErrorÂ readingÂ environmentÂ variableÂ fromÂ QinglongÂ Panel.\n${JSON.stringify(e)}`);b();i+=1;O(t,a,i)});returnÂ r}else{throwÂ newÂ Error("AnÂ errorÂ occurredÂ whileÂ readingÂ environmentÂ variableÂ fromÂ QinglongÂ Panel.")}}asyncÂ functionÂ S(e){letÂ n=null;constÂ r=awaitÂ O();for(constÂ tÂ ofÂ r){if(t.id===e){n=t;break}}returnÂ n}asyncÂ functionÂ $(n){letÂ r=false;awaitÂ f.put({url:`/api/envs/disable`,headers:{accept:"application/json","accept-Language":"zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6",connection:"keep-alive","content-type":"application/json;charset=UTF-8","user-agent":"Mozilla/5.0Â (WindowsÂ NTÂ 10.0;Â Win64;Â x64)Â AppleWebKit/537.36Â (KHTML,Â likeÂ Gecko)Â Chrome/102.0.5005.63Â Safari/537.36Â Edg/102.0.1245.30"},body:n}).then(e=>{if(e.body.code===200){o.debug(`QINGLONGÂ DISABLEDÂ ENVÂ IDS:Â ${n}`);r=true}else{o.error(`ErrorÂ disablingÂ environmentÂ variableÂ fromÂ QinglongÂ Panel.\n${JSON.stringify(e)}`)}}).catch(e=>{o.error(`ErrorÂ disablingÂ environmentÂ variableÂ fromÂ QinglongÂ Panel.\n${e.message}`)});returnÂ r}asyncÂ functionÂ Q(n){letÂ r=false;awaitÂ f.put({url:`/api/envs/enable`,headers:{accept:"application/json","accept-language":"zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6",connection:"keep-alive","content-type":"application/json;charset=UTF-8","user-agent":"Mozilla/5.0Â (WindowsÂ NTÂ 10.0;Â Win64;Â x64)Â AppleWebKit/537.36Â (KHTML,Â likeÂ Gecko)Â Chrome/102.0.5005.63Â Safari/537.36Â Edg/102.0.1245.30"},body:n}).then(e=>{if(e.body.code===200){o.debug(`QINGLONGÂ ENABLEDÂ ENVÂ IDS:Â ${n}`);r=true}else{o.error(`ErrorÂ enablingÂ environmentÂ variableÂ fromÂ QilongÂ panel.\n${JSON.stringify(e)}`)}}).catch(e=>{o.error(`ErrorÂ enablingÂ environmentÂ variableÂ fromÂ QilongÂ panel.\n${e.message}`)});returnÂ r}asyncÂ functionÂ q(e,n="",r=""){letÂ t=false;awaitÂ f.post({url:`/api/scripts`,headers:{"content-type":"application/json"},body:{filename:e,path:n,content:r}}).then(e=>{if(e.body.code===200){t=true}else{o.error(`ErrorÂ readingÂ dataÂ fromÂ QinglongÂ Panel.\n${JSON.stringify(e)}`)}}).catch(e=>{o.error(`ErrorÂ readingÂ dataÂ fromÂ QinglongÂ Panel.\n${e.message}`)});returnÂ t}asyncÂ functionÂ P(r,t="",a=0){if(a<=3){letÂ n="";awaitÂ f.get({url:`/api/scripts/${r}`,params:{path:t}}).then(asyncÂ e=>{if(e.body.code===200){n=e.body.data}else{o.error(`ErrorÂ readingÂ dataÂ fromÂ QinglongÂ Panel.\n${JSON.stringify(e)}`);awaitÂ b();a+=1;returnÂ awaitÂ P(r,t,a)}}).catch(asyncÂ e=>{o.error(`ErrorÂ readingÂ dataÂ fromÂ QinglongÂ Panel.\n${e.message?e.message:e}`);awaitÂ b();a+=1;returnÂ awaitÂ P(r,t,a)});returnÂ n}else{throwÂ newÂ Error("AnÂ errorÂ occurredÂ whileÂ readingÂ theÂ dataÂ fromÂ QinglongÂ Panel.")}}asyncÂ functionÂ j(e,n="",r=""){letÂ t=false;awaitÂ f.put({url:`/api/scripts`,headers:{"content-type":"application/json"},body:{filename:e,path:n,content:r}}).then(e=>{if(e.body.code===200){t=true}else{o.error(`ErrorÂ readingÂ dataÂ fromÂ QinglongÂ Panel.\n${JSON.stringify(e)}`)}}).catch(e=>{o.error(`ErrorÂ readingÂ dataÂ fromÂ QinglongÂ Panel.\n${e.message}`)});returnÂ t}asyncÂ functionÂ k(e,n=""){letÂ r=false;awaitÂ f.delete({url:`/api/scripts`,headers:{"content-type":"application/json"},body:{filename:e,path:n}}).then(e=>{if(e.body.code===200){r=true}else{o.error(`ErrorÂ readingÂ dataÂ fromÂ QinglongÂ Panel.\n${JSON.stringify(e)}`)}}).catch(e=>{o.error(`ErrorÂ readingÂ dataÂ fromÂ QinglongÂ Panel.\n${e.message}`)});returnÂ r}asyncÂ functionÂ T(e,n,r=""){letÂ t=awaitÂ P(g,"");letÂ a=s.convertToObject(t);letÂ i=s.write(e,n,r,a);t=JSON.stringify(a,null,4);letÂ o=awaitÂ j(g,"",t);returnÂ o&&i}asyncÂ functionÂ J(...n){letÂ e=awaitÂ P(g,"");letÂ r=s.convertToObject(e);for(letÂ eÂ ofÂ n){s.write(e[0],e[1],typeofÂ e[2]!=="undefined"?e[2]:"",r)}e=JSON.stringify(r,null,4);returnÂ awaitÂ j(g,"",e)}asyncÂ functionÂ G(e,n,r,t=s.defaultValueComparator){letÂ a=awaitÂ P(g,"");letÂ i=s.convertToObject(a);constÂ o=s.update(e,n,r,t,i);letÂ l=false;if(o===true){a=JSON.stringify(i,null,4);l=awaitÂ j(g,"",a)}returnÂ o&&l}asyncÂ functionÂ _(...n){letÂ e=awaitÂ P(g,"");letÂ r=s.convertToObject(e);for(letÂ eÂ ofÂ n){s.update(e[0],e[1],typeofÂ e[2]!=="undefined"?e[2]:"",typeofÂ e[3]!=="undefined"?e["comparator"]:s.defaultValueComparator,r)}e=JSON.stringify(r,null,4);returnÂ awaitÂ j(g,"",e)}asyncÂ functionÂ L(e,n,r="",t=false){letÂ a=awaitÂ P(g,"");letÂ i=s.convertToObject(a);returnÂ s.read(e,n,r,t,i)}asyncÂ functionÂ x(...n){letÂ e=awaitÂ P(g,"");letÂ r=s.convertToObject(e);letÂ t=[];for(letÂ eÂ ofÂ n){constÂ a=s.read(e[0],e[1],typeofÂ e[2]!=="undefined"?e[2]:"",typeofÂ e[3]==="boolean"?e[3]:false,r);t.push(a)}returnÂ t}asyncÂ functionÂ D(e,n=""){letÂ r=awaitÂ P(g,"");letÂ t=s.convertToObject(r);constÂ a=s.del(e,n,t);r=JSON.stringify(t,null,4);constÂ i=awaitÂ j(g,"",r);returnÂ a&&i}asyncÂ functionÂ W(...n){letÂ e=awaitÂ P(g,"");letÂ r=s.convertToObject(e);for(letÂ eÂ ofÂ n){s.del(e[0],typeofÂ e[1]!=="undefined"?e[1]:"",r)}e=JSON.stringify(r,null,4);returnÂ awaitÂ j(g,"",e)}asyncÂ functionÂ z(e){letÂ n=awaitÂ P(g,"");letÂ r=s.convertToObject(n);returnÂ s.allSessionNames(e,r)}asyncÂ functionÂ A(e){letÂ n=awaitÂ P(g,"");letÂ r=s.convertToObject(n);returnÂ s.allSessions(e,r)}return{url:i||s.read("magic_qlurl"),init:t,getToken:v,setEnv:w,setEnvs:E,getEnv:S,getEnvs:O,delEnvs:N,disableEnvs:$,enableEnvs:Q,addScript:q,getScript:P,editScript:j,delScript:k,write:T,read:L,del:D,update:G,batchWrite:J,batchRead:x,batchUpdate:_,batchDel:W,allSessions:A,allSessionNames:z}}//Â @formatter:on